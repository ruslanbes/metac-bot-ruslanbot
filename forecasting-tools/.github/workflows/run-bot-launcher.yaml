on:
  workflow_call:
    inputs:
      bot_name:
        required: true
        type: string
      cache_key:
        required: false
        type: string
        default: ""
    secrets:
      INPUT_METACULUS_TOKEN:
        required: true
      INPUT_OPENAI_API_KEY:
        required: false
      INPUT_ANTHROPIC_API_KEY:
        required: false
      INPUT_GEMINI_API_KEY:
        required: false
      INPUT_XAI_API_KEY:
        required: false
      INPUT_TOGETHERAI_API_KEY:
        required: false
      INPUT_EXA_API_KEY:
        required: false
      INPUT_PERPLEXITY_API_KEY:
        required: false
      INPUT_ASKNEWS_CLIENT_ID:
        required: false
      INPUT_ASKNEWS_SECRET:
        required: false
      INPUT_OPENROUTER_API_KEY:
        required: false

jobs:
  run_bot:
    runs-on: ubuntu-latest
    environment: aib_bots
    timeout-minutes: 55
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install poetry
        id: installPoetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
        timeout-minutes: 2
        continue-on-error: true

      - name: Sleep for 30 seconds
        if: steps.installPoetry.outcome == 'failure'
        run: sleep 30

      # Reinstall steps are here because the snok install doesn't work ~1/43 times on average
      - name: Retry install poetry as needed
        uses: abatilo/actions-poetry@v4
        id: retryInstallPoetry
        continue-on-error: true
        if: steps.installPoetry.outcome == 'failure'
        # with:
        #   virtualenvs-create: true
        #   virtualenvs-in-project: true
        #   installer-parallel: true
        timeout-minutes: 2

      - name: Final retry install poetry as needed
        uses: snok/install-poetry@v1
        if: steps.retryInstallPoetry.outcome == 'failure'
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          # installer-parallel: true
        timeout-minutes: 2

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Restore AskNews cache
        id: cache-restore
        if: inputs.cache_key != ''
        uses: actions/cache/restore@v3
        with:
          path: ~/.cache
          key: ${{ inputs.cache_key }}

      - name: Verify cache was restored
        if: inputs.cache_key != ''
        run: |
          echo "Cache key: ${{ inputs.cache_key }}"
          echo "Cache hit: ${{ steps.cache-restore.outputs.cache-hit }}"
          echo "Cache directory contents:"
          ls -la ~/.cache/forecasting_tools/asknews/ || echo "Cache directory not found"
          if [ "${{ steps.cache-restore.outputs.cache-hit }}" != "true" ]; then
            echo "WARNING: Cache was not restored."
          fi

      - name: Run bot
        run: |
          poetry run python run_bots.py ${{ inputs.bot_name }}
        env:
          METACULUS_TOKEN: ${{ secrets.INPUT_METACULUS_TOKEN }}
          ASKNEWS_CLIENT_ID: ${{ secrets.INPUT_ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.INPUT_ASKNEWS_SECRET }}
          ASKNEWS_CACHE_MODE: use_cache_with_fallback
          OPENAI_API_KEY: ${{ secrets.INPUT_OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.INPUT_ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.INPUT_GEMINI_API_KEY }}
          XAI_API_KEY: ${{ secrets.INPUT_XAI_API_KEY }}
          TOGETHERAI_API_KEY: ${{ secrets.INPUT_TOGETHERAI_API_KEY }}
          EXA_API_KEY: ${{ secrets.INPUT_EXA_API_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.INPUT_PERPLEXITY_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.INPUT_OPENROUTER_API_KEY }}
          PYTHONPATH: .
